cockroach={}function cockroach.processRequest(a,b)local c,d,e=string.match(b,"(%u+)%s(%S+)%sHTTP/(%S+)")if c==nil or d==nil or e==nil then return end;local f=string.match(b,"Content%-Type:%s(%S+)")if f==nil then return end;local g=string.match(b,".+\r\n\r\n(.+)")if g==nil then return end;for h,i in ipairs(webFiles)do if i.target==d then if i.file~=nil then sendFile(a,i.file,i.mime)return else local f,j=i.action(f,g)if f~=nil and j~=nil then sendSmallString(a,j,f)end;return end end end;cockroach.sendStatusCode(a,"404 Not Found")end;function cockroach.start(k)srv=net.createServer(net.TCP)srv:listen(k,function(l)l:on("receive",cockroach.processRequest)end)end;function cockroach.loadConfig(m)end;function cockroach.stop()end;function cockroach.getFileSize(n)local o=file.list()local p,i;for p,i in pairs(o)do if p==n then return i end end;return 0 end;function cockroach.sendFileWorker(q,r)if r.fname==""then return end;if r.fpos>=r.size then q:close()r=nil;collectgarbage()return end;file.open(r.fname)file.seek("set",r.fpos)local j=file.read(500)r.fpos=r.fpos+500;q:send(j)file.close()end;function cockroach.sendStatusCode(a,s)local t=string.format("<html><head><title>%s</title></head><body><h1>%s</h1></body></html>",s,s)a:send(string.format("HTTP/1.1 %s\nServer: ESP8266\nContent-length: %d\nContent-type: text/html\r\n\r\n%s",s,#t,t))end;function cockroach.sendFile(a,u,v)local r={fname=u,fpos=0,size=cockroach.getFileSize(u)}a:on("sent",function(q)cockroach.sendFileWorker(q,r)end)a:send(string.format("HTTP/1.1 200 OK\nServer: ESP8266\nContent-length: %d\nContent-type: %s\r\n\r\n",r.size,v))end;function cockroach.sendSmallString(a,j,f)a:send(string.format("HTTP/1.1 200 OK\nServer: ESP8266\nContent-length: %d\nContent-type: %s\r\n\r\n%s",#j,f,j))end
